<?php
// Mage Grid Component Template
//
// This template renders the main grid UI using Grid.js (https://gridjs.io/docs)
// It is designed for maximum flexibility, AI-driven extension, and easy customization.
//
// Key features:
// - Dynamic field and filter rendering
// - AJAX data loading and server-side pagination
// - Customizable columns and cell formatters
// - Integration with additional HTML/JS templates (see $block->getAditionalHTML())
//
// For full Grid.js documentation and advanced configuration, see:
// https://gridjs.io/docs

$fields = array_keys($block->getFieldsNames()); // array: ['id', 'order_number', ...]
$fieldsFull = $block->getFields(); // associative array: ['id' => 'ID', ...]
$jsonGridData = $block->getGridJsonData(); // JSON-encoded grid data
$fieldsConfig = $block->getFieldsConfig();
$tableName = $block->getTableName();
$fieldsNames = $block->getFieldsNames();
$aditionalHTML = $block->getAditionalHTML();
$fieldsHtml = $block->getFieldsHtml();
// Get filter values from request
$filters = $this->getRequest()->getParam('filter', []);

// Process field configurations and filter values
$processedFields = $block->getProcessedFields($fields, $fieldsConfig, $filters);


$filterData = [
    'fields' => $processedFields,
    'filters' => $filters
];
// Now start rendering the template
?>
<div id="grid-wrapper">
    <!-- Render filters through block method -->
    <?= $block->getFiltersHtml($filterData) ?>

    <!-- Main grid container (Grid.js will render here) -->
    <div id="wrapper"></div>

    <!-- Grid.js CSS theme -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

    <!-- Dropdown for selecting page size -->
    <div>
        <label for="pageSize">Show per page:</label>
        <select id="pageSize">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="40">40</option>
            <option value="100">100</option>
        </select>
        <label for="totalCount"></label>
    </div>
</div>

<script type="module">
    import { Grid, html } from 'https://unpkg.com/gridjs/dist/gridjs.module.js';

    document.addEventListener('DOMContentLoaded', function() {
        // NOTE: gridData is loaded via AJAX in the server config below
        const gridData = [];

        // Read pagination and filter state from URL
        const urlParams = new URLSearchParams(window.location.search);
        const defaultLimit = parseInt(urlParams.get('limit')) || 40;
        const defaultPage = parseInt(urlParams.get('page')) || 1;
        const totalCount = 0;
        const fieldsConfig = <?php echo json_encode($fieldsConfig); ?>;
        const fieldsNames = <?php echo json_encode($fieldsNames); ?>;
        const columnFilters = Object.keys(fieldsNames);

        // List of fields that should be rendered as HTML (customize as needed)
        const htmlFields = <?php echo json_encode($fieldsHtml); ?>;

        // Define columns for Grid.js, using HTML formatter for special fields
        const gridColumns = columnFilters.map(fieldName => {
            const config = fieldsConfig[fieldName] || {};
            // Use the label from fieldsNames
            const displayName = fieldsNames[fieldName];
            
            let columnConfig = {
                name: displayName,
                attributes: (cell, row, colIndex) => {
                    if (config.hidden) {
                        return {
                            style: 'display: none !important'
                        };
                    }
                    return {};
                }
            };

            if (htmlFields.includes(fieldName)) {
                columnConfig.formatter = cell => {
                    if (!cell) return '';
                    return html(cell);
                };
            }

            return columnConfig;
        });

        // Initialize Grid.js with server-side data loading and pagination
        const grid = new Grid({
            columns: gridColumns,
            data: gridData, // Will be replaced by AJAX
            pagination: {
                enabled: true,
                limit: defaultLimit,
                resetPageOnUpdate: true,
                page: defaultPage,
                total: totalCount, // Will be set by server response
                server: {
                    url: (prev, page, limit) => {
                        // Compose AJAX URL for server-side pagination
                        let curentUrl = window.location.href;
                        const delimeter = curentUrl.includes('?') ? '&' : '?';
                        let url = `${prev}${delimeter}limit=${limit}&offset=${page * limit}&data=true`;
                        return url;
                    }
                }
            },
            server: {
                url: window.location.href,
                then: data => {
                    if (data.error) {
                        console.error('Error in grid data:', data.error);
                        return [];
                    }
                    if (!data || !data.data) {
                        console.error('Error: Invalid data structure received', data);
                        return [];
                    }
                    return data.data;
                },
                total: data => {
                    if (!data.total) {
                        console.error('Error: Invalid total count received', data);
                        return 0;
                    }
                    return data.total;
                }
            },
            sort: true,
            search: true,
            resizable: true
        }).render(document.getElementById('wrapper'));

        // Update URL with current page on pagination change
        grid.on('pagination:changed', function(page) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            window.history.replaceState(null, '', url.toString());
        });

        //grid.on('rowClick', (...args) => console.log('row: ' + JSON.stringify(args), args));
        //grid.on('cellClick', (...args) => console.log('cell: ' + JSON.stringify(args), args));

        // Page size dropdown
        document.getElementById('pageSize').addEventListener('change', function() {
            const newLimit = parseInt(this.value, 10);
            const url = new URL(window.location.href);
            url.searchParams.set('limit', newLimit);
            window.location.href = url.toString();
        });

        if (document.getElementById("pageSize")) {
            document.getElementById("pageSize").value = defaultLimit;
        }
    });
</script>

<!-- Render any additional HTML/JS templates configured via layout XML -->
<?= $block->getAditionalHTML() ?>
